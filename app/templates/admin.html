{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <!-- Stats -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-purple">Total Messages</h6>
                    <h2 class="mb-0">{{ stats.total_messages }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-purple">Total Channels</h6>
                    <h2 class="mb-0">{{ stats.total_channels }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-purple">Total Users</h6>
                    <h2 class="mb-0">{{ stats.total_users }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">Upload Slack Export</h5>
            <p class="text-muted mb-4">Upload your Slack export ZIP file here. The file will be processed and indexed for searching.</p>
            
            <form id="uploadForm" method="post" action="/admin/upload" enctype="multipart/form-data">
                <div class="input-group mb-3">
                    <input type="file" class="form-control" id="file" name="file" accept=".zip">
                    <button type="submit" id="uploadButton" class="btn btn-primary">Upload</button>
                </div>
            </form>
            
            <div id="uploadProgress" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div id="uploadStatus" class="text-primary">Uploading...</div>
                    <div class="text-muted">
                        <span id="uploadedSize">0</span>/<span id="totalSize">0</span> MB
                    </div>
                </div>
                <div class="progress" style="height: 8px;">
                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="text-end mt-2">
                    <small class="text-muted"><span id="uploadPercent">0</span>% complete</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Uploads -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">Recent Uploads</h5>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Status</th>
                            <th>Size</th>
                            <th>Created</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for upload in uploads %}
                        <tr data-upload-id="{{ upload._id }}">
                            <td>{{ upload.filename }}</td>
                            <td>
                                {% if upload.status in ['IMPORTING', 'importing_channels', 'extracting', 'generating_embeddings'] %}
                                <div>
                                    <span class="badge bg-info mb-1">{{ upload.status | title }}</span>
                                    {% if upload.progress %}
                                    <div class="progress" style="height: 4px;">
                                        {% set percent = upload.get('progress_percent', 0) %}
                                        <div class="progress-bar progress-bar-striped {% if percent < 100 %}progress-bar-animated{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ percent }}%"
                                             aria-valuenow="{{ percent }}"
                                             aria-valuemin="0"
                                             aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">{{ upload.progress }}</small>
                                    {% endif %}
                                </div>
                                {% elif upload.status == 'complete' %}
                                <div>
                                    <span class="badge bg-success">Complete</span>
                                    {% if upload.progress and 'Imported 0 channels' in upload.progress %}
                                    <span class="text-muted ms-2">No messages imported</span>
                                    {% endif %}
                                </div>
                                {% elif upload.status == 'error' %}
                                <div>
                                    <span class="badge bg-danger" title="{{ upload.error }}">Error</span>
                                </div>
                                {% elif upload.status == 'UPLOADING' %}
                                <span class="badge bg-primary">Uploading</span>
                                {% elif upload.status == 'UPLOADED' %}
                                <div>
                                    <span class="badge bg-secondary">Uploaded</span>
                                </div>
                                {% elif upload.status == 'cancelled' %}
                                <div>
                                    <span class="badge bg-warning">Cancelled</span>
                                </div>
                                {% else %}
                                <span class="badge bg-secondary">{{ upload.status }}</span>
                                {% endif %}
                            </td>
                            <td>{{ "{:,.0f}".format(upload.size / 1024 / 1024) }} MB</td>
                            <td>{{ upload.created_at | timedelta }}</td>
                            <td class="text-end">
                                {% if upload.status in ['IMPORTING', 'importing_channels', 'extracting', 'generating_embeddings'] %}
                                <form action="/admin/import/{{ upload._id }}/cancel" method="post" style="display: inline;">
                                    <button type="submit" class="btn btn-sm btn-warning">Cancel</button>
                                </form>
                                {% elif upload.status in ['UPLOADED', 'cancelled', 'error'] or (upload.status == 'complete' and upload.progress and 'Imported 0 channels' in upload.progress) %}
                                <form class="import-form" style="display: inline;">
                                    <input type="hidden" name="upload_id" value="{{ upload._id }}">
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        {% if upload.status == 'UPLOADED' %}Start Import
                                        {% else %}Retry Import{% endif %}
                                    </button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not uploads %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">
                                No uploads yet
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Clear Data Section -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title mb-3">Clear Data</h5>
            <p class="text-muted mb-4">Select which data you want to clear. This action cannot be undone.</p>
            
            <form action="/admin/clear" method="post">
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="clear_messages" name="clear_messages">
                        <label class="form-check-label" for="clear_messages">Clear Messages</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="clear_embeddings" name="clear_embeddings">
                        <label class="form-check-label" for="clear_embeddings">Clear Embeddings</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="clear_uploads" name="clear_uploads">
                        <label class="form-check-label" for="clear_uploads">Clear Uploads</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="clear_conversations" name="clear_conversations">
                        <label class="form-check-label" for="clear_conversations">Clear Conversations</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-danger" id="clearButton" disabled>Clear Selected Data</button>
            </form>
        </div>
    </div>
</div>

<script>
// Enable clear button only when at least one checkbox is checked
const clearForm = document.querySelector('form[action="/admin/clear"]');
const clearButton = document.getElementById('clearButton');
const clearCheckboxes = clearForm.querySelectorAll('input[type="checkbox"]');

function updateClearButton() {
    clearButton.disabled = ![...clearCheckboxes].some(cb => cb.checked);
}

clearCheckboxes.forEach(cb => {
    cb.addEventListener('change', updateClearButton);
});

// Handle file upload with progress
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('file');
    const file = fileInput.files[0];
    if (!file) {
        alert('Please select a file first');
        return;
    }

    // Disable upload button
    const uploadButton = document.getElementById('uploadButton');
    uploadButton.disabled = true;
    uploadButton.classList.add('opacity-50');

    // Show progress bar
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const uploadPercent = document.getElementById('uploadPercent');
    const uploadStatus = document.getElementById('uploadStatus');
    const uploadedSize = document.getElementById('uploadedSize');
    const totalSize = document.getElementById('totalSize');
    
    uploadProgress.classList.remove('d-none');
    totalSize.textContent = (file.size / (1024 * 1024)).toFixed(1);

    // Create XHR request
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/admin/upload');
    
    // Track upload progress
    xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = percent + '%';
            uploadPercent.textContent = percent;
            uploadedSize.textContent = (e.loaded / (1024 * 1024)).toFixed(1);
        }
    };

    // Handle state changes
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                uploadStatus.textContent = 'Upload complete!';
                uploadStatus.classList.remove('text-primary');
                uploadStatus.classList.add('text-success');
                progressBar.classList.add('bg-success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                uploadStatus.textContent = 'Upload failed!';
                uploadStatus.classList.remove('text-primary');
                uploadStatus.classList.add('text-danger');
                progressBar.classList.add('bg-danger');
                uploadButton.disabled = false;
                uploadButton.classList.remove('opacity-50');
                try {
                    const response = JSON.parse(xhr.responseText);
                    alert('Upload failed: ' + (response.detail || xhr.statusText));
                } catch (e) {
                    alert('Upload failed: ' + xhr.statusText);
                }
            }
        }
    };

    // Create form data and send
    const formData = new FormData();
    formData.append('file', file);
    xhr.send(formData);
});

// Handle import form submission
document.querySelectorAll('.import-form').forEach(form => {
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const uploadId = this.querySelector('[name="upload_id"]').value;
        const button = this.querySelector('button');
        
        try {
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Starting...';
            
            const response = await fetch(`/admin/import/${uploadId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.detail || `HTTP error! status: ${response.status}`);
            }
            
            // Start polling for status updates
            pollImportStatus();
            
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to start import: ' + error.message);
            button.disabled = false;
            button.textContent = 'Start Import';
        }
    });
});

// Poll for import status updates
function pollImportStatus() {
    const importingRows = document.querySelectorAll('tr[data-upload-id]');
    
    importingRows.forEach(row => {
        const uploadId = row.dataset.uploadId;
        const statusCell = row.querySelector('td:nth-child(2)'); // Status is in second column
        
        // Check status every 2 seconds
        const interval = setInterval(async () => {
            try {
                const response = await fetch(`/admin/import/${uploadId}/status`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update the status cell with the new status
                if (data.status === 'extracting' || data.status === 'importing_channels' || data.status === 'generating_embeddings') {
                    statusCell.innerHTML = `
                        <div>
                            <span class="badge bg-info mb-1">${data.status.charAt(0).toUpperCase() + data.status.slice(1)}</span>
                            ${data.progress ? `
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: ${data.progress_percent}%"
                                     aria-valuenow="${data.progress_percent}"
                                     aria-valuemin="0"
                                     aria-valuemax="100"></div>
                            </div>
                            <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">${data.progress}</small>
                            ` : ''}
                        </div>
                    `;
                }
                
                // If import is complete or errored, stop polling and refresh
                if (data.status === 'complete' || data.status === 'error') {
                    clearInterval(interval);
                    window.location.reload();
                }
                
            } catch (error) {
                console.error('Error polling status:', error);
                clearInterval(interval);
            }
        }, 2000);
    });
}

// Start polling if there are any imports in progress
const hasActiveImports = document.querySelector('tr[data-upload-id]') !== null;
if (hasActiveImports) {
    setInterval(pollImportStatus, 2000);
}
</script>
{% endblock %}
