{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Search Info -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">About Search</h5>
                    <p class="text-muted mb-3">This search combines two powerful methods:</p>
                    <ul class="text-muted mb-3">
                        <li><strong>Keyword Search:</strong> Finds exact word matches (like traditional search)</li>
                        <li><strong>AI Search:</strong> Understands meaning and finds conceptually related messages</li>
                    </ul>
                    <p class="text-muted mb-0">Use the slider below to balance between these methods based on your needs.</p>
                </div>
            </div>

            <!-- Search Form -->
            <div class="card mb-4">
                <div class="card-body">
                    <form id="searchForm" class="mb-0">
                        <!-- Search Input -->
                        <div class="mb-4">
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="query" 
                                   name="query" 
                                   value="{{ query }}"
                                   placeholder="Enter your search query...">
                        </div>

                        <!-- Search Balance -->
                        <div class="mb-4">
                            <label class="form-label">Search Balance</label>
                            <div class="d-flex align-items-center gap-3">
                                <span class="text-muted">Keyword Search</span>
                                <input type="range" 
                                       class="form-range flex-grow-1" 
                                       id="hybrid_alpha" 
                                       name="hybrid_alpha" 
                                       min="0" 
                                       max="1" 
                                       step="0.1" 
                                       value="0.5">
                                <span class="text-muted">AI Search</span>
                            </div>
                            <div class="text-center text-muted small">
                                Current: <span id="hybrid_alpha_value">50% Balanced</span>
                            </div>
                        </div>

                        <!-- Search Options -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label class="form-label">Results</label>
                                <select class="form-select" id="limit" name="limit">
                                    <option value="5">5 results</option>
                                    <option value="10" selected>10 results</option>
                                    <option value="20">20 results</option>
                                    <option value="50">50 results</option>
                                </select>
                            </div>
                            <div class="col-md-9">
                                <label class="form-label">Filters</label>
                                <div class="d-flex gap-4">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="filter_has_files" name="filter_has_files">
                                        <label class="form-check-label" for="filter_has_files">Has Files</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="filter_has_reactions" name="filter_has_reactions">
                                        <label class="form-check-label" for="filter_has_reactions">Has Reactions</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="filter_in_thread" name="filter_in_thread">
                                        <label class="form-check-label" for="filter_in_thread">Thread Replies</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search Button -->
                        <div class="text-end">
                            <button type="submit" class="btn btn-lg btn-primary px-4">
                                Search Messages
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Loading State -->
            <div id="searchLoading" class="d-none">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mb-0">Searching messages...</p>
                </div>
            </div>

            <!-- Results -->
            <div id="results">
                {% if results %}
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">Search Results</h5>
                    <span class="text-muted">{{ results|length }} results</span>
                </div>

                {% for result in results %}
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="d-flex gap-3">
                                <div class="message-channel">
                                    <a href="/conversation/{{ result.conversation_id }}{% if result.thread_ts %}#{{ result.thread_ts }}{% else %}#{{ result.ts }}{% endif %}" 
                                       class="text-decoration-none">
                                        #{{ result.conversation.name if result.conversation else result.conversation_id }}
                                    </a>
                                </div>
                                <div class="message-user text-muted">
                                    {{ result.user }}
                                </div>
                                <div class="message-time text-muted">
                                    {{ result.timestamp | timedelta }}
                                </div>
                            </div>
                            {% if result.score is defined %}
                            <div class="message-score">
                                <span class="badge bg-light text-dark">
                                    Score: {{ "%.2f"|format(result.score) }}
                                    {% if result.semantic_score is defined %}
                                    (S: {{ "%.2f"|format(result.semantic_score) }},
                                     K: {{ "%.2f"|format(result.keyword_score) }})
                                    {% endif %}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="message-text">{{ result.text }}</div>
                    </div>
                </div>
                {% endfor %}
                {% elif query %}
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="bi bi-search" style="font-size: 3rem;"></i>
                    </div>
                    <h5>No results found</h5>
                    <p class="text-muted">Try adjusting your search terms or filters</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('hybrid_alpha').addEventListener('input', function(e) {
    const value = e.target.value;
    const percent = Math.round(value * 100);
    const text = percent === 50 ? 'Balanced' : 
                 percent > 50 ? 'Keyword Search' : 'AI Search';
    document.getElementById('hybrid_alpha_value').textContent = `${percent}% ${text}`;
});

document.getElementById('searchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Show loading state
    const loading = document.getElementById('searchLoading');
    const results = document.getElementById('results');
    loading.classList.remove('d-none');
    results.innerHTML = '';
    
    const form = e.target;
    const query = form.query.value;
    const hybrid_alpha = parseFloat(form.hybrid_alpha.value);
    const limit = parseInt(form.limit.value);
    const filter_has_files = form.filter_has_files?.checked;
    const filter_has_reactions = form.filter_has_reactions?.checked;
    const filter_in_thread = form.filter_in_thread?.checked;
    
    try {
        const response = await fetch('/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                query: query,
                hybrid_alpha: hybrid_alpha,
                limit: limit,
                filter_has_files: filter_has_files || null,
                filter_has_reactions: filter_has_reactions || null,
                filter_in_thread: filter_in_thread || null
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Hide loading state
        loading.classList.add('d-none');
        
        if (data.results && data.results.length > 0) {
            results.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">Search Results</h5>
                    <span class="text-muted">${data.results.length} results</span>
                </div>
                ${data.results.map(result => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="d-flex gap-3">
                                    <div class="message-channel">
                                        <a href="/conversation/${result.conversation_id}#${result.thread_ts || result.ts}" 
                                           class="text-decoration-none">
                                            #${result.conversation?.name || result.conversation_id}
                                        </a>
                                    </div>
                                    <div class="message-user text-muted">
                                        ${result.user}
                                    </div>
                                    <div class="message-time text-muted">
                                        ${new Date(result.timestamp).toLocaleString()}
                                    </div>
                                </div>
                                <div class="message-score">
                                    <span class="badge bg-light text-dark">
                                        Score: ${result.score.toFixed(2)}
                                        (S: ${result.semantic_score.toFixed(2)},
                                         K: ${result.keyword_score.toFixed(2)})
                                    </span>
                                </div>
                            </div>
                            <div class="message-text">${result.text}</div>
                        </div>
                    </div>
                `).join('')}
            `;
        } else {
            results.innerHTML = `
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="bi bi-search" style="font-size: 3rem;"></i>
                    </div>
                    <h5>No results found</h5>
                    <p class="text-muted">Try adjusting your search terms or filters</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error:', error);
        loading.classList.add('d-none');
        results.innerHTML = `
            <div class="alert alert-danger" role="alert">
                <h5 class="alert-heading">Error</h5>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    }
});
</script>
{% endblock %}
